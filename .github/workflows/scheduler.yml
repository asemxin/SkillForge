name: SkillForge Scheduler

on:
  # å®šæ—¶è§¦å‘ - æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */6 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      skill:
        description: 'è¦æ‰§è¡Œçš„æŠ€èƒ½åç§° (ç•™ç©ºæ‰§è¡Œæ‰€æœ‰å®šæ—¶æŠ€èƒ½)'
        required: false
        type: string
      backend:
        description: 'AI åŽç«¯'
        required: false
        type: choice
        options:
          - antigravity
          - claude
          - gemini
          - openai
        default: gemini

env:
  PYTHON_VERSION: '3.11'

jobs:
  run-skills:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ”§ Configure Environment
        run: |
          echo "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" >> $GITHUB_ENV
          echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> $GITHUB_ENV

      - name: ðŸš€ Run Skills
        run: |
          if [ -n "${{ github.event.inputs.skill }}" ]; then
            python -m src.runner run --skill "${{ github.event.inputs.skill }}" --backend "${{ github.event.inputs.backend || 'gemini' }}"
          else
            python -m src.runner run --all-scheduled
          fi

      - name: ðŸ“Š Generate Index
        run: python -m src.runner run --generate-index

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reports-${{ github.run_id }}
          path: output/
          retention-days: 30

      - name: ðŸš€ Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
          force_orphan: true

  notify:
    needs: run-skills
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: ðŸ“§ Notify on Failure
        run: |
          echo "SkillForge æ‰§è¡Œå¤±è´¥!"
          echo "Run ID: ${{ github.run_id }}"
          echo "è¯·æ£€æŸ¥ Actions æ—¥å¿—"
